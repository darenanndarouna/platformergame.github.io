<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="2人対戦のプラットフォームゲームです。GitHub Pagesで公開中。"/>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>対戦型プラットフォーマー</title>
  <style>
    *{box-sizing:border-box}body{margin:0;overflow:hidden;height:100vh;background:linear-gradient(#9ed6ff,#bfe9ff)}
    .sun{position:absolute;right:6vh;top:4vh;width:140px;height:140px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff59d,#ffd27a 40%,#ffc34d 60%,#ffb347 100%);filter:blur(4px)}
    .g{position:absolute;left:0;right:0;bottom:0;height:20vh;background:linear-gradient(to top,#84331F 70%,#3ea34a 30%);box-shadow:0 -6px 20px rgba(0,0,0,.15) inset}
    .c{position:absolute;width:40px;height:40px;will-change:transform;pointer-events:none}
    .i{width:100%;height:100%;display:flex;align-items:center;justify-content:center;transition:transform .08s linear}
    .b{width:100%;height:100%;background:#000;border-radius:10px;transform-origin:center bottom;transition:transform .12s ease,border-radius .12s;box-shadow:0 6px 12px rgba(0,0,0,.25)}
    .c.walking .b{animation:walk .36s linear infinite;border-radius:9px}@keyframes walk{0%{transform:translateY(0) scaleY(1)}50%{transform:translateY(-6px) scaleY(.95)}100%{transform:translateY(0) scaleY(1)}}
    .c.jumping .b{animation:none;transform:translateY(0) scaleY(1.12);border-radius:8px}
    .c.land .b{animation:land .18s ease forwards}@keyframes land{0%{transform:translateY(0) scaleY(1.08)}50%{transform:translateY(0) scaleY(.82)}100%{transform:translateY(0) scaleY(1)}}
    .i.left{transform:scaleX(-1)}
    .s{position:absolute;left:50%;bottom:-6px;width:24px;height:6px;margin-left:-12px;background:rgba(0,0,0,.25);border-radius:50%;filter:blur(4px);transition:transform .12s,opacity .12s}
    .c.jumping .s{transform:scale(.6);opacity:.6}
    .c.land .s{transform:scale(1.05);opacity:.9}
    .label{position:fixed;transform:translateX(-50%);font-size:12px;font-weight:700;pointer-events:none;z-index:10}
    .hp{position:fixed;top:10px;left:10px;width:160px;height:18px;background:rgba(0,0,0,.15);border-radius:10px;overflow:hidden}
    .hp .in{height:100%;background:rgba(255,100,100,.9);width:100%}
    .hp.r{left:auto;right:10px}
    .hp.r .in{background:rgba(100,140,255,.95)}
    .bullet{position:absolute;width:14px;height:14px;border-radius:50%;background:#ff4b4b;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff}
    .btxt{position:absolute;top:-14px;font-size:10px;font-weight:700;pointer-events:none}
    .ov{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;z-index:999;display:none}
    /* シールド（ガード時の青い丸） */
    .shield{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);pointer-events:none;border-radius:50%;
            width:160px;height:160px;background:rgba(100,140,255,0.25);z-index:-1;transition:transform .04s linear,opacity .04s linear}
    /* ヒップドロップ時の見た目（簡易） */
    .hip .b{background:linear-gradient(#333,#000)}
  </style>
</head>
<body>
  <div class="sun"></div>
  <div class="g" id="g"></div>
  <div class="c" id="p1"><div class="i" id="i1"><div class="b"></div></div><div class="s"></div></div>
  <div class="c" id="p2"><div class="i" id="i2"><div class="b"></div></div><div class="s"></div></div>
  <div class="label" id="l1" style="color:rgba(160,90,90,.9)">1P</div>
  <div class="label" id="l2" style="color:rgba(90,120,160,.95)">2P</div>
  <div class="hp" id="h1"><div class="in" id="hi1"></div></div>
  <div class="hp r" id="h2"><div class="in" id="hi2"></div></div>
  <div class="ov" id="ov"></div>
  <script>
    const g=document.getElementById('g'),p1=document.getElementById('p1'),p2=document.getElementById('p2'),i1=document.getElementById('i1'),i2=document.getElementById('i2'),l1=document.getElementById('l1'),l2=document.getElementById('l2'),hi1=document.getElementById('hi1'),hi2=document.getElementById('hi2'),ov=document.getElementById('ov');
    const W=40,H=40,S=6,G=1,J=-18,BS=9;let sw=innerWidth,sh=innerHeight,k={};
    addEventListener('resize',()=>{sw=innerWidth;sh=innerHeight});
    addEventListener('keydown',e=>k[e.key]=1);
    addEventListener('keyup',e=>k[e.key]=0);

    // 試合数
    let R=Math.max(1,parseInt(prompt('何本勝負にしますか？','3'))||3);

    // プレイヤー構造体初期化（ガードのためのプロパティを追加）
    let p=[{
      x:20,y:0,vx:0,vy:0,last:1,on:1,hp:100,guardKey:'g',guardHeld:0,alive:1,w:0,
      el:p1,ie:i1,l:l1,
      // guard properties
      guardMax:5000, // ms
      guardRemain:5000, // ms remaining while actively holding guard
      guardRechargeTimer:0, // ms counting when not holding
      guardRecharged:false, // true when fully recharged (after 5s not holding)
      lastShot:0, // ms
      hip:false, hipTimer:0
    },{
      x:sw-W-20,y:0,vx:0,vy:0,last:-1,on:1,hp:100,guardKey:'.',guardHeld:0,alive:1,w:0,
      el:p2,ie:i2,l:l2,
      guardMax:5000, guardRemain:5000, guardRechargeTimer:0, guardRecharged:false,
      lastShot:0,
      hip:false, hipTimer:0
    }];

    // 初期位置
    function gy(){return g.getBoundingClientRect().top}
    p[0].y=p[1].y=gy()-H;

    // 弾の配列
    let B=[];
    function mk(x,y,v,o,isAir){
      let e=document.createElement('div'),t=document.createElement('div');
      e.className='bullet';t.className='btxt';t.textContent=o==0?'1P':'2P';e.appendChild(t);document.body.appendChild(e);
      B.push({e,x,y,v,o,t,created:Date.now(),life:isAir?600:4000,air:!!isAir}); // 空中弾は寿命短め
    }

    // リスポーン
    function resp(i){
      p[i].alive=0;
      setTimeout(()=>{
        p[i].x=Math.random()*(sw-W);
        p[i].y=gy()-H;
        p[i].hp=100;
        p[i].alive=1;
        // reset guard state on respawn
        p[i].guardRemain=p[i].guardMax; p[i].guardRechargeTimer=0; p[i].guardRecharged=false;
      },800)
    }

    // 衝突判定：弾が当たったか
    function hit(b,pl){
      if(!pl.alive||pl===p[b.o])return false;
      // if actively guarding and has remaining guard time -> block bullet
      if(pl.guardHeld && pl.guardRemain>0){
        // block bullet, consume some guard time
        pl.guardRemain = Math.max(0, pl.guardRemain - 300); // ブロックごとに300ms消費
        if(pl.guardRemain===0){ pl.guardHeld=0 } // guard depleted
        return 'blocked';
      }
      // if guard has been recharged and player is NOT actively holding guard, then one-stage guard triggers
      if(pl.guardRecharged && !pl.guardHeld){
        pl.guardRecharged=false;
        pl.guardRemain=0; // consume
        pl.guardRechargeTimer=0;
        // one-stage guard reduces damage (半減)
        let damage = (b.air?10:20) / 2;
        pl.hp -= damage;
        // small knockback
        pl.x += (b.v>0?6:-6);
        pl.vy = -8;
        return true;
      }
      // otherwise normal hit
      let dmg = b.air ? 10 : 20;
      pl.hp -= dmg;
      pl.x += (b.v>0?6:-6);
      pl.vy = -8;
      return true;
    }

    // ヒップドロップの当たり判定（接触）
    function hipCheck(attacker, target){
      if(!attacker.hip || !attacker.alive || !target.alive) return false;
      let ax=attacker.x, ay=attacker.y, bx=target.x, by=target.y;
      if(ax+W>bx && ax<bx+W && ay+H>by && ay<by+H){
        // ヒップでヒット
        target.hp -= 30;
        // ノックバック
        target.x += (attacker.last>0?8:-8);
        target.vy = -6;
        attacker.hip = false; // 一回ヒットで終了
        attacker.hipTimer = 0;
        return true;
      }
      return false;
    }

    // シールド要素をプレイヤー要素に追加（見た目）
    p.forEach((u, idx)=>{
      let sh=document.createElement('div');
      sh.className='shield';
      sh.style.display='none';
      u.shieldEl=sh;
      u.el.appendChild(sh);
    });

    // アニメーションループ（タイムスタンプ管理）
    let lastTime = performance.now();
    function upd(now){
      let dt = now - lastTime; if(dt>50) dt=50; lastTime = now;
      let ground = gy()-H;

      for(let i=0;i<2;i++){
        let u=p[i];
        // 入力
        let left=i==0?(k['a']||0):(k['ArrowLeft']||0),
            right=i==0?(k['d']||0):(k['ArrowRight']||0);
        if(right && !left){ u.x += S; u.last = 1 }
        else if(left && !right){ u.x -= S; u.last = -1 }

        // ジャンプ
        if((i==0?(k['w']||0):(k['ArrowUp']||0)) && Math.abs(u.y-ground) < 0.5) u.vy = J;
        u.vy += G; u.y += u.vy;
        if(u.y > ground){ u.y = ground; u.vy = 0; u.on = 1 } else u.on = 0;
        if(u.x < 0) u.x = 0; if(u.x+W > sw) u.x = sw-W;

        // ヒップドロップ：空中で特定キーを押すと発動
        let hipKey = (i==0 ? k['s'] : k['ArrowDown']);
        if(!u.on && hipKey && !u.hip){
          // 発動
          u.hip = true;
          u.hipTimer = 0;
          u.vy = 20; // 急降下
          u.el.classList.add('hip');
        }
        // ヒップ中はタイマー進め、着地で解除
        if(u.hip){
          u.hipTimer += dt;
          if(u.on){ u.hip = false; u.el.classList.remove('hip'); u.hipTimer = 0 }
        }

        // ガード管理
        u.guardHeld = !!k[u.guardKey];
        if(u.guardHeld && u.guardRemain > 0){
          // 押している間は減っていく
          u.guardRemain = Math.max(0, u.guardRemain - dt);
          u.guardRechargeTimer = 0;
          if(u.guardRemain === 0){
            u.guardHeld = 0; // depleted
          }
        } else {
          // 押していないときは回復カウント
          u.guardRechargeTimer += dt;
          if(u.guardRechargeTimer >= u.guardMax && !u.guardRecharged){
            u.guardRecharged = true; // 5秒待つと回復（ワンタイムの一段階ガード）
            u.guardRemain = u.guardMax; // fully recharged
            u.guardRechargeTimer = 0;
          }
        }

        // シールド表示：押している間だけ表示し、残り時間に応じて縮小・透過
        if(u.guardHeld && u.guardRemain > 0){
          u.shieldEl.style.display = 'block';
          let ratio = u.guardRemain / u.guardMax;
          u.shieldEl.style.transform = 'translate(-50%,-50%) scale(' + (0.4 + 0.6*ratio) + ')';
          u.shieldEl.style.opacity = (0.25 * ratio + 0.05).toString();
        } else {
          u.shieldEl.style.display = 'none';
        }

        // 表示更新
        u.el.style.transform = 'translate('+u.x+'px,'+u.y+'px)';
        u.ie.classList.toggle('left', u.last < 0);
        u.el.classList.toggle('walking', (left||right) && u.on);
        u.el.classList.toggle('jumping', !u.on);
        if(!u.on){ u.el.classList.add('land'); clearTimeout(u._t); u._t=setTimeout(()=>u.el.classList.remove('land'),200) }
        u.l.style.left = (u.x + W/2) + 'px';
        u.l.style.bottom = (sh - u.y + 6) + 'px';
      }

      // 弾発射（クールダウン 0.5s = 500ms）
      let nowMs = Date.now();
      // 1P shooting: 'f'
      if((k['f']||0) && p[0].alive){
        if(nowMs - p[0].lastShot >= 500){
          p[0].lastShot = nowMs;
          // 空中で撃つと近距離弾（スピード小）
          let isAir = !p[0].on;
          let speed = BS * p[0].last * (isAir ? 0.4 : 1);
          mk(p[0].x + W/2 - 7, p[0].y + H/2 - 7, speed, 0, isAir);
        }
      }
      // 2P shooting: ','
      if((k[',']||0) && p[1].alive){
        if(nowMs - p[1].lastShot >= 500){
          p[1].lastShot = nowMs;
          let isAir = !p[1].on;
          let speed = BS * p[1].last * (isAir ? 0.4 : 1);
          mk(p[1].x + W/2 - 7, p[1].y + H/2 - 7, speed, 1, isAir);
        }
      }

      // 弾の更新
      for(let i=B.length-1;i>=0;i--){
        let bb=B[i];
        bb.x += bb.v;
        bb.e.style.transform = 'translate('+bb.x+'px,'+bb.y+'px)';
        // life check
        if(Date.now() - bb.created > bb.life){ bb.e.remove(); B.splice(i,1); continue }
        if(bb.x < -30 || bb.x > sw+30){ bb.e.remove(); B.splice(i,1); continue }
        let targ = p[1-bb.o];
        let res = hit(bb, targ);
        if(res === 'blocked'){
          // blocked: create small effect? just remove bullet
          bb.e.remove(); B.splice(i,1);
          // If guarding, and guardRemain got to 0, start recharge timer
          if(targ.guardRemain === 0){ targ.guardRechargeTimer = 0; targ.guardRecharged = false; }
          continue;
        } else if(res){
          // hit did damage
          bb.e.remove(); B.splice(i,1);
          if(targ.hp <= 0){
            p[bb.o].w++;
            if(p[bb.o].w >= R){
              ov.style.display='flex'; ov.textContent=(bb.o==0?'1P':'2P')+'の勝ち';
              return; // stop loop
            }
            resp(1-bb.o)
          }
        } else {
          // not hit, adjust the small label position
          bb.t.style.left = '50%';
        }
      }

      // ヒップドロップの当たり判定（両者チェック）
      hipCheck(p[0], p[1]);
      hipCheck(p[1], p[0]);

      // HPバー更新
      hi1.style.width = Math.max(0, p[0].hp) + '%';
      hi2.style.width = Math.max(0, p[1].hp) + '%';

      requestAnimationFrame(upd);
    }

    requestAnimationFrame(upd);
  </script>
</body>
</html>
